// Generated by CoffeeScript 1.3.3
(function() {
  var History, blogpost_prefix, cache, converter, fix_static_content, get_gist, gist_url, gists_url, homepage, load_gist, load_gist_into, pages_prefix, site_title_long, site_title_short, username,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  username = 'btoews';

  site_title_short = 'm.y.';

  site_title_long = 'mastahyeti';

  pages_prefix = /gistblog-sitepage/;

  blogpost_prefix = /gistblog-blogpost/;

  gists_url = 'https://api.github.com/users/' + username + '/gists?callback=?';

  gist_url = 'https://api.github.com/gists/';

  homepage = '2495861';

  History = window.History;

  cache = {};

  converter = new Showdown.converter();

  get_gist = function(id, callback) {
    var url;
    if (__indexOf.call(cache, id) >= 0) {
      return callback(cache[id]);
    } else {
      url = gist_url + id + '?callback=?';
      return $.getJSON(url, function(response) {
        cache[id] = response;
        return callback(response);
      });
    }
  };

  load_gist_into = function(id, $target) {
    return get_gist(id, function(response) {
      var date, description;
      if (response.data.user.login === username) {
        description = response.data.description.split(':').slice(1).join(':');
        $target.find('.title').html(description);
        date = new Date(response.data.created_at);
        $target.find('.date').html(date.toLocaleDateString() + " - " + date.toLocaleTimeString());
        $target.find('.linktopost').prop('href', "#" + response.data.id);
        $target.find('.content').html('');
        $.each(response.data.files, function(k, v) {
          var content, fnparts;
          fnparts = v.filename.split('.');
          content = v.content;
          if (fnparts[fnparts.length - 1] === 'md') {
            content = converter.makeHtml(content);
          }
          return $target.find('.content').append(content);
        });
        return fix_static_content();
      }
    });
  };

  load_gist = function() {
    var id;
    id = location.hash.slice(1);
    if (id === '' || id === '#') {
      id = homepage;
      location.hash = homepage;
    }
    load_gist_into(id, $('#maincontent'));
    $('.active').removeClass('active');
    return $('.jslink#' + location.hash.slice(1)).parent().addClass('active');
  };

  fix_static_content = function() {
    $('.site_title_short').html(site_title_short);
    $('.site_title_long').html(site_title_long);
    $('a.site_title_short').prop('href', '#' + homepage);
    return $('a.site_title_long').prop('href', '#' + homepage);
  };

  $(window).on('hashchange', load_gist);

  $('.brand').mouseenter(function(e) {
    return $(this).html(site_title_long);
  });

  $('.brand').mouseleave(function(e) {
    return $(this).html(site_title_short);
  });

  $(document).ready(function() {
    fix_static_content();
    load_gist();
    return $.getJSON(gists_url, function(response) {
      var $nav, $posts_dropdown, gist, id, pagename, post_count, _i, _len, _ref;
      if (response.meta.status !== 200) {
        console.log(response);
        return alert('Ajax error');
      } else {
        post_count = 0;
        $nav = $('<ul class="nav"></ul>');
        $posts_dropdown = $('<li class="dropdown"><a href="#"class="dropdown-toggle"data-toggle="dropdown">Posts<b class="caret"></b></a><ul class="dropdown-menu"></ul></li>');
        _ref = response.data;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          gist = _ref[_i];
          if (gist.description.match(pages_prefix)) {
            pagename = gist.description.split(':').slice(1).join(':');
            id = gist.id;
            $nav.append("<li class='navelement'><a href='#" + id + "' id='" + id + "' class='jslink'>" + pagename + "</a></li>");
          }
          if (gist.description.match(blogpost_prefix)) {
            pagename = gist.description.split(':').slice(1).join(':');
            id = gist.id;
            $('.dropdown-menu', $posts_dropdown).append("<li class='navelement'><a href='#" + id + "' id='" + id + "' class='jslink'>" + pagename + "</a></li>");
            if (post_count < 3) {
              load_gist_into(id, $("#preview" + post_count));
            }
            post_count++;
          }
        }
        $nav.append($posts_dropdown);
        $('.nav-collapse').append($nav);
        $('.active').removeClass('active');
        $('.jslink#' + location.hash.slice(1)).parent().addClass('active');
        $('.overlay').addClass('fadeout').removeClass('pre-fadeout');
        if ($('.overlay').css('opacity') === 0) {
          return $('.overlay').hide();
        } else {
          return setTimeout("$('.overlay').hide()", 250);
        }
      }
    });
  });

}).call(this);
